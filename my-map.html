<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Festival Map ‚Äî MyFestMap</title>
    <meta name="description" content="Track and share the festivals you've attended on an interactive map.">
    
    <!-- Open Graph for social sharing -->
    <meta property="og:title" content="My Festival Map ‚Äî MyFestMap">
    <meta property="og:description" content="Check out the festivals I've been to!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://myfestmap.com/my-map.html">
    
    <!-- Clerk Authentication -->
    <script
        data-clerk-publishable-key="pk_test_YXBwYXJlbnQtY2FsZi0xMC5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://cdn.clerk.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        async
    ></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --accent: #00ff88;
            --accent-dim: #00cc6a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --border: #2a2a3a;
            --gradient-1: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-primary); 
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }
        
        /* Header */
        header { 
            padding: 16px 0; 
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
        }
        .header-inner { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .logo { 
            font-family: 'Space Grotesk', sans-serif; 
            font-size: 1.5rem; 
            font-weight: 700; 
            color: var(--accent); 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        .logo-icon { 
            width: 32px; 
            height: 32px; 
            background: var(--gradient-1); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .header-btn {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .header-btn:hover {
            border-color: var(--accent);
            background: rgba(0, 255, 136, 0.1);
        }
        
        .header-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-dark);
        }
        
        .header-btn.primary:hover {
            background: var(--accent-dim);
        }
        
        /* Page Title */
        .page-hero {
            padding: 32px 0;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        
        .page-hero h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .page-hero .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* Stats Bar */
        #map-stats {
            display: flex;
            gap: 32px;
            justify-content: center;
            padding: 24px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
        }
        
        .gs-stat {
            text-align: center;
        }
        
        .gs-stat-num {
            display: block;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1;
        }
        
        .gs-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }
        
        /* Map Container */
        #festival-map {
            flex: 1;
            min-height: 500px;
        }
        
        /* Empty State */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
            text-align: center;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .empty-state h2 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.75rem;
            margin-bottom: 12px;
        }
        
        .empty-state p {
            color: var(--text-secondary);
            max-width: 400px;
            margin-bottom: 24px;
        }
        
        .empty-state .cta {
            padding: 14px 32px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: var(--bg-dark);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s;
        }
        
        .empty-state .cta:hover {
            transform: translateY(-2px);
        }
        
        /* Legend */
        .map-legend {
            padding: 16px 24px;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
        }
        
        .legend-title {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            .page-hero h1 {
                font-size: 1.75rem;
            }
            
            #map-stats {
                gap: 16px;
                flex-wrap: wrap;
            }
            
            .gs-stat-num {
                font-size: 1.75rem;
            }
            
            .header-inner {
                flex-direction: column;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* Override Leaflet popup styles */
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        .leaflet-popup-content {
            margin: 16px;
            color: var(--text-primary);
        }
        
        .leaflet-popup-tip {
            background: var(--bg-card);
        }
        
        .leaflet-container {
            background: var(--bg-dark);
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-inner">
            <a href="index.html" class="logo"><span class="logo-icon">üó∫Ô∏è</span>MyFestMap</a>
            <div class="header-actions">
                <a href="browse.html" class="header-btn">Browse Festivals</a>
                <a href="my-recap.html" class="header-btn">üìä My Recap</a>
                <button class="header-btn" onclick="GroundScoreMap.startCompare()">ü§ù Compare</button>
                <button class="header-btn primary" onclick="showShareModal()">üì§ Share</button>
                <div id="user-button"></div>
                <button class="header-btn" id="auth-btn" style="display:none;">Sign In</button>
            </div>
        </div>
    </header>
    
    <section class="page-hero">
        <div class="container">
            <h1>üìç My Festival Map</h1>
            <p class="subtitle">Every pin is a memory. Every year is a story.</p>
        </div>
    </section>
    
    <div id="map-stats">
        <div class="gs-stat"><span class="gs-stat-num">0</span><span class="gs-stat-label">Total Visits</span></div>
        <div class="gs-stat"><span class="gs-stat-num">0</span><span class="gs-stat-label">Festivals</span></div>
        <div class="gs-stat"><span class="gs-stat-num">0</span><span class="gs-stat-label">Years</span></div>
        <div class="gs-stat"><span class="gs-stat-num">0</span><span class="gs-stat-label">States</span></div>
    </div>
    
    <div id="festival-map"></div>
    
    <div class="map-legend">
        <div class="legend-title">Years</div>
        <div class="legend-items">
            <div class="legend-item"><span class="legend-dot" style="background: #ff6b6b"></span> 2020</div>
            <div class="legend-item"><span class="legend-dot" style="background: #feca57"></span> 2021</div>
            <div class="legend-item"><span class="legend-dot" style="background: #48dbfb"></span> 2022</div>
            <div class="legend-item"><span class="legend-dot" style="background: #ff9ff3"></span> 2023</div>
            <div class="legend-item"><span class="legend-dot" style="background: #54a0ff"></span> 2024</div>
            <div class="legend-item"><span class="legend-dot" style="background: #5f27cd"></span> 2025</div>
            <div class="legend-item"><span class="legend-dot" style="background: #00d2d3"></span> 2026</div>
        </div>
    </div>
    
    <!-- CTA Banner for inbound users viewing a shared map -->
    <div id="compare-cta-banner" style="display:none;">
        <div class="container">
            <div class="cta-content">
                <div class="cta-icon">üéØ</div>
                <div class="cta-text">
                    <strong>See which festivals you have in common!</strong>
                    <span>Build your own map to unlock the overlap view</span>
                </div>
                <a href="browse.html" class="cta-btn-primary">Start My Map ‚Üí</a>
            </div>
        </div>
    </div>
    
    <style>
        #compare-cta-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            border-top: 2px solid var(--accent);
            padding: 20px 0;
            z-index: 1000;
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .cta-content {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .cta-icon { font-size: 2rem; }
        .cta-text { text-align: left; }
        .cta-text strong { display: block; font-size: 1.1rem; color: #fff; }
        .cta-text span { color: var(--text-secondary); font-size: 0.9rem; }
        .cta-btn-primary {
            background: var(--gradient-1);
            color: #000;
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 700;
            text-decoration: none;
            white-space: nowrap;
        }
        .cta-btn-primary:hover { transform: scale(1.05); }
        
        /* Share Modal */
        #share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .share-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #12121a 100%);
            border-radius: 24px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            border: 1px solid #2a2a4a;
            box-shadow: 0 30px 80px rgba(0,0,0,0.6);
        }
        .share-modal-header {
            margin-bottom: 24px;
        }
        .share-modal-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        .share-modal-header h2 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: #fff;
        }
        .share-modal-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .share-preview {
            background: #0a0a0f;
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #2a2a3a;
        }
        .share-preview-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 12px;
        }
        .overlap-preview {
            display: flex;
            justify-content: center;
            gap: 16px;
            align-items: center;
        }
        .overlap-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .overlap-circle.you {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }
        .overlap-circle.friend {
            background: linear-gradient(135deg, #54a0ff, #2e86de);
            color: #fff;
        }
        .overlap-circle .num {
            font-size: 1.5rem;
            line-height: 1;
        }
        .overlap-circle .label {
            font-size: 0.65rem;
            text-transform: uppercase;
        }
        .overlap-connector {
            color: var(--accent);
            font-size: 1.5rem;
        }
        .share-link-box {
            display: flex;
            gap: 8px;
            margin: 20px 0;
        }
        .share-link-input {
            flex: 1;
            background: #0a0a0f;
            border: 1px solid #2a2a3a;
            border-radius: 8px;
            padding: 14px 16px;
            color: #fff;
            font-size: 0.9rem;
            font-family: monospace;
        }
        .share-copy-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }
        .share-copy-btn:hover { background: #00cc6a; }
        .share-copy-btn.copied {
            background: #10b981;
        }
        .share-note {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 12px;
        }
        .share-close {
            background: none;
            border: 1px solid #3a3a5a;
            color: var(--text-secondary);
            padding: 10px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 16px;
        }
        .share-close:hover {
            border-color: var(--accent);
            color: #fff;
        }
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/map.js"></script>
    <script src="js/lists.js"></script>
    <script>
        // Festival coordinates database
        const FESTIVAL_COORDS = {
            'coachella': { lat: 33.6803, lng: -116.2389 },
            'edc-las-vegas': { lat: 36.27, lng: -115.0095 },
            'electric-forest': { lat: 43.6508, lng: -85.9781 },
            'bonnaroo': { lat: 35.4753, lng: -86.0559 },
            'lollapalooza': { lat: 41.8758, lng: -87.6189 },
            'ultra-miami': { lat: 25.7826, lng: -80.1868 },
            'burning-man': { lat: 40.7864, lng: -119.2065 },
            'tomorrowland': { lat: 51.0909, lng: 4.3641 },
            'glastonbury': { lat: 51.1503, lng: -2.5853 },
            'movement': { lat: 42.3293, lng: -83.0458 },
            'outside-lands': { lat: 37.7694, lng: -122.4862 },
            'austin-city-limits': { lat: 30.2653, lng: -97.749 },
            'lost-lands': { lat: 39.8953, lng: -82.8833 },
            'electric-zoo': { lat: 40.7935, lng: -73.9316 },
            'hard-summer': { lat: 34.0689, lng: -117.648 },
            'escape': { lat: 34.0689, lng: -117.648 },
            'beyond-wonderland-socal': { lat: 34.0689, lng: -117.648 },
            'hulaween': { lat: 30.2394, lng: -83.0099 },
            'okeechobee': { lat: 27.2439, lng: -80.8295 },
            'shambhala': { lat: 49.3194, lng: -117.6437 },
            'lightning-in-a-bottle': { lat: 35.6772, lng: -120.1625 },
            'bass-canyon': { lat: 47.1007, lng: -119.994 },
            'sonic-bloom': { lat: 38.8859, lng: -106.9808 },
            'desert-hearts': { lat: 33.705, lng: -116.395 },
            'dirtybird-campout': { lat: 35.6772, lng: -120.1625 },
            'iii-points': { lat: 25.786, lng: -80.1918 },
            'crssd-festival': { lat: 32.7118, lng: -117.1579 },
            'portola': { lat: 37.7749, lng: -122.3917 },
            'second-sky': { lat: 37.7507, lng: -122.2006 },
            'imagine': { lat: 33.6409, lng: -84.4479 },
            'firefly': { lat: 39.1882, lng: -75.5249 },
            'governors-ball': { lat: 40.7935, lng: -73.9316 },
            'hangout': { lat: 30.2803, lng: -87.5697 },
            'amsterdam-dance-event': { lat: 52.3676, lng: 4.9041 },
            'awakenings': { lat: 52.3909, lng: 4.939 },
            'defqon-1': { lat: 52.181, lng: 5.72 },
            'mysteryland': { lat: 52.431, lng: 5.0676 },
            'sziget': { lat: 47.5438, lng: 19.0529 },
            'exit-festival': { lat: 45.2561, lng: 19.8457 },
            'sonar-barcelona': { lat: 41.3819, lng: 2.177 },
            'primavera-sound-barcelona': { lat: 41.3873, lng: 2.192 },
            'melt-festival': { lat: 51.57, lng: 12.297 },
            'time-warp': { lat: 49.4896, lng: 8.4718 },
            'fusion-festival': { lat: 53.35, lng: 12.75 },
            'hideout': { lat: 44.5333, lng: 14.9 },
            'outlook-festival': { lat: 44.8666, lng: 13.85 },
            'boom-festival': { lat: 39.8167, lng: -7.75 },
            'arc-music-festival': { lat: 41.8758, lng: -87.627 },
            'spring-awakening': { lat: 41.882, lng: -87.619 },
            'north-coast': { lat: 41.882, lng: -87.619 }
        };
        
        let map = null;
        let markers = [];
        let festivalsData = [];
        
        // Initialize map
        async function initMap() {
            // Load festival data
            try {
                const resp = await fetch('js/festivals.json');
                festivalsData = await resp.json();
            } catch (e) {
                console.error('Failed to load festivals:', e);
            }
            
            // Check for share link
            const shareData = GroundScoreMap.loadFromShare();
            if (shareData) {
                renderSharedMap(shareData);
                return;
            }
            
            // Create map centered on US
            map = L.map('festival-map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Render user's festivals
            renderUserMap();
        }
        
        function renderUserMap() {
            // Clear existing markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            const been = GroundScoreMap.getBeen();
            const years = GroundScoreMap.getYears();
            const stats = GroundScoreMap.getStats();
            
            // Update stats display
            document.querySelectorAll('.gs-stat-num')[0].textContent = stats.totalVisits;
            document.querySelectorAll('.gs-stat-num')[1].textContent = stats.festivals;
            document.querySelectorAll('.gs-stat-num')[2].textContent = stats.years;
            
            // Count unique states/countries
            const regions = new Set();
            been.forEach(slug => {
                const fest = festivalsData.find(f => f.slug === slug);
                if (fest && fest.location) {
                    const parts = fest.location.split(',');
                    if (parts.length > 1) regions.add(parts[parts.length - 1].trim());
                }
            });
            document.querySelectorAll('.gs-stat-num')[3].textContent = regions.size;
            
            // Add markers
            been.forEach(slug => {
                const coords = FESTIVAL_COORDS[slug];
                const fest = festivalsData.find(f => f.slug === slug);
                if (!coords || !fest) return;
                
                const festYears = years[slug] || [];
                const latestYear = festYears.length > 0 ? Math.max(...festYears) : 2024;
                const color = GroundScoreMap.YEAR_COLORS[latestYear] || '#00ff88';
                
                const marker = L.circleMarker([coords.lat, coords.lng], {
                    radius: 10,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                const yearText = festYears.length > 0 ? festYears.join(', ') : 'Added';
                marker.bindPopup(`
                    <div style="text-align:center;">
                        <strong style="font-size:1.1rem;">${fest.name}</strong><br>
                        <span style="color:#a0a0b0;">${fest.location}</span><br>
                        <span style="color:${color};font-weight:600;">${yearText}</span>
                    </div>
                `);
                
                markers.push(marker);
            });
            
            // Fit bounds if we have markers
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        function renderSharedMap(data) {
            const friendBeen = data.been || [];
            const friendYears = data.years || {};
            const myBeen = GroundScoreMap.getBeen();
            const myYears = GroundScoreMap.getYears();
            const hasOwnMap = myBeen.length > 0;
            
            // Calculate overlap
            const overlap = friendBeen.filter(f => myBeen.includes(f));
            
            // Update header based on context
            if (hasOwnMap && overlap.length > 0) {
                document.querySelector('.page-hero h1').textContent = 'üéØ Festival Overlap';
                document.querySelector('.page-hero .subtitle').textContent = 
                    `You have ${overlap.length} festival${overlap.length === 1 ? '' : 's'} in common!`;
            } else if (hasOwnMap) {
                document.querySelector('.page-hero h1').textContent = 'üìç Compare Maps';
                document.querySelector('.page-hero .subtitle').textContent = 'No overlap yet ‚Äî discover new festivals!';
            } else {
                document.querySelector('.page-hero h1').textContent = 'üìç A Friend\'s Festival Map';
                document.querySelector('.page-hero .subtitle').textContent = 'Build your own to see what you have in common!';
                // Show CTA banner
                document.getElementById('compare-cta-banner').style.display = 'block';
            }
            
            // Create map
            map = L.map('festival-map').setView([39.8283, -98.5795], 4);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Update stats for friend's map
            let totalVisits = 0;
            const uniqueYears = new Set();
            Object.values(friendYears).forEach(fy => {
                fy.forEach(y => {
                    totalVisits++;
                    uniqueYears.add(y);
                });
            });
            
            document.querySelectorAll('.gs-stat-num')[0].textContent = totalVisits || friendBeen.length;
            document.querySelectorAll('.gs-stat-num')[1].textContent = friendBeen.length;
            document.querySelectorAll('.gs-stat-num')[2].textContent = uniqueYears.size;
            if (hasOwnMap) {
                document.querySelectorAll('.gs-stat-label')[0].textContent = 'Their Visits';
                document.querySelectorAll('.gs-stat-label')[1].textContent = 'Their Festivals';
                // Show overlap in 4th stat
                document.querySelectorAll('.gs-stat-num')[3].textContent = overlap.length;
                document.querySelectorAll('.gs-stat-label')[3].textContent = 'In Common';
            }
            
            // Add markers for friend's festivals
            friendBeen.forEach(slug => {
                const coords = FESTIVAL_COORDS[slug];
                const fest = festivalsData.find(f => f.slug === slug);
                if (!coords) return;
                
                const festYears = friendYears[slug] || [];
                const isOverlap = overlap.includes(slug);
                const latestYear = festYears.length > 0 ? Math.max(...festYears) : 2024;
                
                // Different styling for overlap vs friend-only
                let color, radius;
                if (isOverlap) {
                    color = '#ff8800'; // Orange for overlap
                    radius = 14;
                } else {
                    color = '#54a0ff'; // Blue for friend's
                    radius = 10;
                }
                
                const marker = L.circleMarker([coords.lat, coords.lng], {
                    radius: radius,
                    fillColor: color,
                    color: isOverlap ? '#fff' : '#2e86de',
                    weight: isOverlap ? 3 : 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                const name = fest ? fest.name : slug;
                const location = fest ? fest.location : '';
                const yearText = festYears.length > 0 ? festYears.join(', ') : 'Attended';
                const overlapBadge = isOverlap ? '<span style="background:#ff8800;color:#000;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:700;">üéØ IN COMMON</span><br>' : '';
                
                marker.bindPopup(`
                    <div style="text-align:center;">
                        ${overlapBadge}
                        <strong style="font-size:1.1rem;">${name}</strong><br>
                        <span style="color:#a0a0b0;">${location}</span><br>
                        <span style="color:${color};font-weight:600;">${yearText}</span>
                    </div>
                `);
                
                markers.push(marker);
            });
            
            // If user has their own map, also show their unique festivals in green
            if (hasOwnMap) {
                myBeen.forEach(slug => {
                    if (friendBeen.includes(slug)) return; // Already shown as overlap
                    
                    const coords = FESTIVAL_COORDS[slug];
                    const fest = festivalsData.find(f => f.slug === slug);
                    if (!coords) return;
                    
                    const festYears = myYears[slug] || [];
                    const latestYear = festYears.length > 0 ? Math.max(...festYears) : 2024;
                    const color = '#00ff88'; // Green for yours only
                    
                    const marker = L.circleMarker([coords.lat, coords.lng], {
                        radius: 8,
                        fillColor: color,
                        color: '#00cc6a',
                        weight: 2,
                        opacity: 0.7,
                        fillOpacity: 0.6
                    }).addTo(map);
                    
                    const name = fest ? fest.name : slug;
                    const location = fest ? fest.location : '';
                    const yearText = festYears.length > 0 ? festYears.join(', ') : 'Attended';
                    
                    marker.bindPopup(`
                        <div style="text-align:center;">
                            <span style="background:#00ff88;color:#000;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:700;">YOUR FEST</span><br>
                            <strong style="font-size:1.1rem;">${name}</strong><br>
                            <span style="color:#a0a0b0;">${location}</span><br>
                            <span style="color:${color};font-weight:600;">${yearText}</span>
                        </div>
                    `);
                    
                    markers.push(marker);
                });
            }
            
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
            
            // Update legend for compare view
            if (hasOwnMap) {
                document.querySelector('.map-legend').innerHTML = `
                    <div class="legend-title">Map Legend</div>
                    <div class="legend-items">
                        <div class="legend-item"><span class="legend-dot" style="background: #ff8800"></span> In Common</div>
                        <div class="legend-item"><span class="legend-dot" style="background: #00ff88"></span> Only You</div>
                        <div class="legend-item"><span class="legend-dot" style="background: #54a0ff"></span> Only Them</div>
                    </div>
                `;
            }
        }
        
        // Share Modal
        let shareLink = '';
        
        function showShareModal() {
            const stats = GroundScoreMap.getStats();
            if (stats.festivals === 0) {
                alert('Add some festivals to your map first!');
                return;
            }
            
            // Generate share link
            const data = GroundScoreMap.getMapData();
            const encoded = btoa(JSON.stringify(data));
            shareLink = `${window.location.origin}${window.location.pathname}?share=${encoded}`;
            
            const modal = document.createElement('div');
            modal.id = 'share-modal';
            modal.innerHTML = `
                <div class="share-modal-content">
                    <div class="share-modal-header">
                        <div class="share-modal-icon">üîó</div>
                        <h2>Share Your Festival Map</h2>
                        <p>Send this to a friend and discover which festivals you have in common!</p>
                    </div>
                    
                    <div class="share-preview">
                        <div class="share-preview-title">What your friend will see</div>
                        <div class="overlap-preview">
                            <div class="overlap-circle you">
                                <span class="num">${stats.festivals}</span>
                                <span class="label">Your fests</span>
                            </div>
                            <div class="overlap-connector">‚ü∑</div>
                            <div class="overlap-circle friend">
                                <span class="num">?</span>
                                <span class="label">Their fests</span>
                            </div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 12px;">
                            They'll build their map, then see the overlap!
                        </p>
                    </div>
                    
                    <div class="share-link-box">
                        <input type="text" class="share-link-input" id="share-link-input" value="${shareLink}" readonly>
                        <button class="share-copy-btn" onclick="copyShareLink()">Copy Link</button>
                    </div>
                    
                    <p class="share-note">üéØ They'll need to add their festivals before the compare unlocks</p>
                    
                    <button class="share-close" onclick="closeShareModal()">Done</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Select the link text
            setTimeout(() => {
                document.getElementById('share-link-input').select();
            }, 100);
        }
        
        function copyShareLink() {
            const input = document.getElementById('share-link-input');
            input.select();
            navigator.clipboard.writeText(shareLink).then(() => {
                const btn = document.querySelector('.share-copy-btn');
                btn.textContent = '‚úì Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy Link';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
        
        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            if (modal) modal.remove();
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initMap);
        
        // Initialize Clerk auth
        window.addEventListener('load', async () => {
            if (typeof Clerk !== 'undefined') {
                try {
                    await Clerk.load();
                    const authBtn = document.getElementById('auth-btn');
                    const userBtn = document.getElementById('user-button');
                    
                    if (Clerk.user) {
                        Clerk.mountUserButton(userBtn);
                        authBtn.style.display = 'none';
                    } else {
                        authBtn.style.display = 'block';
                        authBtn.onclick = () => Clerk.openSignIn();
                    }
                } catch (err) {
                    console.log('Clerk not configured:', err);
                }
            }
        });
    </script>
    <!-- Vercel Analytics -->
    <script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
